# File Management API

Надёжный Node.js/Express-сервер для загрузки, скачивания, удаления и инспекции файлов в выделенной рабочей директории `Repo`. Все операции жёстко ограничены пределами этого каталога.

## Запуск локально

```bash
npm install
npm start
```

По умолчанию сервер слушает порт `8000`. Изменить порт можно через переменную окружения `PORT`.

Рабочая директория `Repo` создаётся автоматически при старте сервера и хранится рядом с исходным кодом. Все операции API выполняются только внутри неё.

## Docker

```bash
docker build -t project-file-api .
docker run --rm -p 8000:8000 project-file-api
```

## Маршруты

### `GET /`
Простой health-check с перечислением доступных эндпоинтов.

### `GET /download`
Архивирует и отдаёт содержимое каталога `Repo` в формате ZIP. Дополнительно поддерживает параметр `path`:

- `path` — относительный путь к файлу/директории внутри `Repo`, которые нужно архивировать. По умолчанию архивируется весь каталог `Repo`.

### `GET /api/download`
Идентичный `/download`, добавлен для удобства использования API.

### `POST /api/upload`
Загружает файл в каталог `Repo`.

Параметры запроса:

- `file` (обязательный, form-data) — загружаемый файл.
- `destination` (необязательный, form-data или query) — относительный путь директории внутри `Repo`, куда нужно поместить файл/распаковать архив. По умолчанию — корень `Repo`.
- `extract` (необязательный, form-data или query) — укажите `true`, чтобы автоматически распаковать загруженный ZIP-архив, удалить исходный ZIP и сохранить его содержимое в `destination`. Совпадающие файлы и директории будут перезаписаны содержимым архива.

Ответы:

- `200 Uploaded` — файл загружен впервые. Возвращает путь, по которому сохранён файл.
- `200 Overwritten` — файл с таким именем уже был на сервере и был перезаписан новым содержимым.
- `200 Extracted` — архив распакован. Возвращает список извлечённых файлов/директорий.
- `400` — некорректные параметры или попытка использовать `extract` не для ZIP-архива.

### `GET /api/tree`
Возвращает JSON-дерево директории `Repo` (исключая `.git` и `node_modules`).

Пример ответа:

```json
{
  "name": "Repo",
  "path": ".",
  "type": "directory",
  "children": [
    { "name": "docs", "path": "docs", "type": "directory", "children": [] },
    { "name": "README.md", "path": "README.md", "type": "file" }
  ]
}
```

### `DELETE /api/delete`
Удаляет файл или директорию.

Тело запроса (JSON):

```json
{
  "targetPath": "relative/path/to/file-or-directory"
}
```

Ограничения:

- Нельзя удалять файлы/папки вне `Repo`.
- Нельзя удалить корневую директорию `Repo`.

Ответ `200` содержит тип удалённого объекта и его относительный путь.

### `POST /api/move`
Перемещает или переименовывает файл/директорию по аналогии с `mv`.

Тело запроса (JSON):

```json
{
  "source": "relative/source/path",
  "destination": "relative/destination/path"
}
```

Особенности:

- Если `destination` указывает на существующую директорию, объект перемещается внутрь неё с исходным именем.
- Уже существующий целевой путь перезаписывается (аналог `mv -f`).
- Перемещение корня `Repo` или в собственные подкаталоги запрещено.

### `DELETE /api/deleteall`
Полностью очищает содержимое каталога `Repo`, сохраняя саму директорию.

Ответ `200` содержит количество удалённых объектов и их относительные пути.

## Проверка API через curl

```bash
# Дерево каталога Repo
curl http://localhost:8000/api/tree | jq

# Загрузка файла в подкаталог Repo/docs
curl -F "file=@README.md" -F "destination=docs" http://localhost:8000/api/upload

# Загрузка и распаковка ZIP-архива
curl -F "file=@archive.zip" "http://localhost:8000/api/upload?extract=true"

# Скачивание каталога Repo
curl -OJ http://localhost:8000/download

# Удаление файла
curl -X DELETE -H "Content-Type: application/json" \
  -d '{"targetPath":"docs/README.md"}' \
  http://localhost:8000/api/delete

# Перемещение файла в другую директорию
curl -X POST -H "Content-Type: application/json" \
  -d '{"source":"docs/README.md","destination":"archived"}' \
  http://localhost:8000/api/move

# Полная очистка каталога Repo
curl -X DELETE http://localhost:8000/api/deleteall
```

## Замечания по безопасности

- Все операции происходят строго в пределах каталога `Repo`.
- Архивы проверяются на наличие попыток выйти за пределы целевой директории.
- Символические ссылки игнорируются при построении дерева.
- Сервер не создаёт временную директорию `uploads`; при старте удаляются возможные остатки от прошлых версий.
- Простая загрузка файлов и распаковка ZIP-архивов перезаписывают совпадающие пути внутри `Repo`.
